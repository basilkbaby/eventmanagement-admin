<div class="ticket-list-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="header-content">
      <div class="title-section">
        <h1>Tickets Management</h1>
        <p>Manage and track all event tickets</p>
      </div>
      
      <div class="header-actions">
        <button mat-raised-button color="primary" routerLink="/admin/tickets/scan">
          <mat-icon>qr_code_scanner</mat-icon>
          Scan Tickets
        </button>
        <button mat-stroked-button color="primary" (click)="exportTickets()" [disabled]="totalCount === 0">
          <mat-icon>download</mat-icon>
          Export
        </button>
      </div>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="stats-section">
    <div class="stats-grid">
      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon total">
            <mat-icon>confirmation_number</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ stats().total }}</div>
            <div class="stat-label">Total Tickets</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon active">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ stats().active }}</div>
            <div class="stat-label">Active</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon used">
            <mat-icon>verified</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ stats().used }}</div>
            <div class="stat-label">Used</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="stat-card">
        <div class="stat-content">
          <div class="stat-icon revenue">
            <mat-icon>attach_money</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">£{{ stats().revenue }}</div>
            <div class="stat-label">Total Revenue</div>
          </div>
        </div>
      </mat-card>
    </div>
  </div>

  <!-- Filters & Bulk Actions -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="search-filter">
        <mat-form-field appearance="outline" class="search-field">
          <mat-icon matPrefix>search</mat-icon>
          <input matInput 
                 placeholder="Search tickets..." 
                 [(ngModel)]="searchTerm" 
                 (keyup)="applyFilters()"
                 [disabled]="loading()">
        </mat-form-field>
      </div>

      <div class="filter-controls">

      <mat-form-field appearance="outline" class="event-filter">
        <mat-label>Event</mat-label>
        <mat-select [(ngModel)]="selectedEvent" (selectionChange)="applyFilters()">
          <mat-option *ngFor="let eventOption of eventOptions" [value]="eventOption.value">
            {{ eventOption.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>


        <mat-form-field appearance="outline">
          <mat-label>Event</mat-label>
          <mat-select [(ngModel)]="selectedEvent" (selectionChange)="applyFilters()">
            <mat-option value="">All Events</mat-option>
            <mat-option *ngFor="let event of events" [value]="event.id">
              {{ event.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select [(ngModel)]="selectedStatus" (selectionChange)="applyFilters()">
            <mat-option *ngFor="let status of statusOptions" [value]="status.value">
              {{ status.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Ticket Type</mat-label>
          <mat-select [(ngModel)]="selectedTicketType" (selectionChange)="applyFilters()">
            <mat-option value="">All Types</mat-option>
            <mat-option *ngFor="let type of ticketTypes" [value]="type.id">
              {{ type.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-stroked-button color="basic" (click)="clearFilters()" class="clear-filters">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions" *ngIf="selection.hasValue()">
      <div class="bulk-info">
        <span class="selected-count">{{ selectedCount }} tickets selected</span>
        <span class="filter-info" *ngIf="filteredCount !== totalCount">
          (of {{ filteredCount }} filtered)
        </span>
      </div>
      
      <div class="bulk-buttons">
        <button mat-stroked-button color="primary" (click)="openBulkOperations()">
          <mat-icon>playlist_add_check</mat-icon>
          Bulk Actions
        </button>
        
        <button mat-icon-button (click)="selection.clear()" matTooltip="Clear selection">
          <mat-icon>clear</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Tickets Table -->
  <div class="table-section">
    <div class="table-header">
      <div class="table-info">
        <span class="results-count">
          Showing {{ dataSource.filteredData.length }} of {{ totalCount }} tickets
        </span>
      </div>
      
      <div class="table-actions">
        <button mat-icon-button (click)="loadTickets()" [disabled]="loading()" matTooltip="Refresh">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="dataSource" matSort class="tickets-table">
        
        <!-- Select Column -->
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              [checked]="isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()"
              (change)="toggleAllRows()"
              [disabled]="loading() || dataSource.filteredData.length === 0">
            </mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox
              [checked]="selection.isSelected(row)"
              (change)="selection.toggle(row)"
              [disabled]="row.status !== TicketStatus.ACTIVE">
            </mat-checkbox>
          </td>
        </ng-container>

        <!-- Ticket Number Column -->
        <ng-container matColumnDef="ticketNumber">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Ticket #</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="ticket-number-cell">
              <strong class="ticket-number">{{ ticket.ticketNumber }}</strong>
              <div class="order-ref" *ngIf="ticket.order">
                Order: {{ ticket.order.orderNumber }}
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Attendee Column -->
        <ng-container matColumnDef="attendee">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Attendee</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="attendee-cell">
              <div class="attendee-name">{{ ticket.attendee.name }}</div>
              <div class="attendee-email">{{ ticket.attendee.email }}</div>
              <div class="attendee-phone" *ngIf="ticket.attendee.phone">
                {{ ticket.attendee.phone }}
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Event Column -->
        <ng-container matColumnDef="event">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Event</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="event-cell">
              <span class="event-name">{{ ticket.eventName }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Ticket Type Column -->
        <ng-container matColumnDef="ticketType">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="ticket-type-cell">
              <span class="type-name">{{ ticket.ticketType.name }}</span>
              <span class="type-description" *ngIf="ticket.ticketType.description">
                {{ ticket.ticketType.description }}
              </span>
            </div>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="status-cell">
              <mat-chip [class]="getStatusClass(ticket.status)" class="status-chip">
                {{ getStatusText(ticket.status) }}
              </mat-chip>
              <div class="scanned-info" *ngIf="ticket.scannedAt">
                Scanned: {{ formatDateTime(ticket.scannedAt) }}
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Price Column -->
        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Price</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="price-cell">
              <span class="final-price">£{{ ticket.price }}</span>
              <span class="original-price" *ngIf="ticket.originalPrice !== ticket.price">
                <s>£{{ ticket.originalPrice }}</s>
              </span>
              <div class="discount-badge" *ngIf="ticket.couponApplied">
                Discount applied
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Purchase Date Column -->
        <ng-container matColumnDef="purchaseDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Purchase Date</th>
          <td mat-cell *matCellDef="let ticket">
            {{ formatDateTime(ticket.purchaseDate) }}
          </td>
        </ng-container>

        <!-- Scanned At Column -->
        <ng-container matColumnDef="scannedAt">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Scanned At</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="scanned-cell">
              <span *ngIf="ticket.scannedAt; else notScanned">
                {{ formatDateTime(ticket.scannedAt) }}
              </span>
              <ng-template #notScanned>
                <span class="not-scanned">Not scanned</span>
              </ng-template>
            </div>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let ticket">
            <div class="actions-cell">
              <button mat-icon-button 
                      color="primary" 
                      [matMenuTriggerFor]="menu" 
                      [matMenuTriggerData]="{ticket: ticket}"
                      [disabled]="loading()">
                <mat-icon>more_vert</mat-icon>
              </button>
              
              <mat-menu #menu="matMenu">
                <ng-template matMenuContent let-ticket="ticket">
                  <button mat-menu-item (click)="viewTicket(ticket)">
                    <mat-icon>visibility</mat-icon>
                    View Details
                  </button>
                  
                  <button mat-menu-item 
                          (click)="scanTicket(ticket)"
                          *ngIf="ticket.status === TicketStatus.ACTIVE">
                    <mat-icon>qr_code_scanner</mat-icon>
                    Scan Ticket
                  </button>
                  
                  <button mat-menu-item 
                          (click)="transferTicket(ticket)"
                          *ngIf="ticket.transferable && ticket.status === TicketStatus.ACTIVE">
                    <mat-icon>swap_horiz</mat-icon>
                    Transfer
                  </button>
                  
                  <button mat-menu-item (click)="resendTicket(ticket)">
                    <mat-icon>email</mat-icon>
                    Resend Ticket
                  </button>

                  <mat-divider></mat-divider>
                  
                  <button mat-menu-item 
                          (click)="refundTicket(ticket)"
                          *ngIf="ticket.status === TicketStatus.ACTIVE"
                          class="warning-action">
                    <mat-icon>monetization_on</mat-icon>
                    Refund Ticket
                  </button>
                  
                  <button mat-menu-item 
                          (click)="cancelTicket(ticket)"
                          *ngIf="ticket.status === TicketStatus.ACTIVE"
                          class="danger-action">
                    <mat-icon>cancel</mat-icon>
                    Cancel Ticket
                  </button>
                </ng-template>
              </mat-menu>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row 
            *matRowDef="let row; columns: displayedColumns;"
            [class.row-selected]="selection.isSelected(row)"
            [class.row-disabled]="row.status !== TicketStatus.ACTIVE">
        </tr>
      </table>

      <!-- Loading State -->
      <div class="loading-state" *ngIf="loading()">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading tickets...</p>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="!loading() && dataSource.filteredData.length === 0">
        <mat-icon class="empty-icon">confirmation_number</mat-icon>
        <h3>No tickets found</h3>
        <p *ngIf="totalCount === 0; else filteredEmpty">
          There are no tickets in the system yet.
        </p>
        <ng-template #filteredEmpty>
          <p>No tickets match your current filters.</p>
          <button mat-raised-button color="primary" (click)="clearFilters()">
            Clear Filters
          </button>
        </ng-template>
      </div>
    </div>

    <!-- Paginator -->
    <mat-paginator [pageSizeOptions]="pageSizeOptions" 
                   [pageSize]="defaultPageSize"
                   showFirstLastButtons
                   [length]="dataSource.filteredData.length">
    </mat-paginator>
  </div>
</div>