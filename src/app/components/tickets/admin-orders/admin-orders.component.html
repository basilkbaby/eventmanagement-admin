<div class="admin-orders-container">
  <!-- Compact Header -->
  <div class="header-section compact">
    <div class="header-content">
      <div class="title-section">
        <h1 class="compact-title">Orders</h1>
        <p class="compact-subtitle">Manage seat orders and payments</p>
      </div>
      
      <div class="header-actions compact">
        <button mat-stroked-button 
                (click)="toggleFilters()" 
                class="filter-toggle compact"
                [class.active]="showFilters()">
          <mat-icon>filter_list</mat-icon>
          Filters
          <span class="filter-badge" *ngIf="getActiveFilterCount() > 0">
            {{ getActiveFilterCount() }}
          </span>
        </button>
        <button mat-stroked-button 
                color="basic" 
                (click)="exportOrders()" 
                [disabled]="loading()"
                class="compact">
          <mat-icon>download</mat-icon>
          Export
        </button>
        <button mat-icon-button 
                (click)="loadData()" 
                [disabled]="loading()" 
                matTooltip="Refresh">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Compact Stats Grid -->
  <div class="stats-section compact" *ngIf="!showFilters()">
    <div class="stats-grid compact">
      <div class="stat-item compact">
        <div class="stat-icon compact orders">
          <mat-icon>receipt</mat-icon>
        </div>
        <div class="stat-info compact">
          <div class="stat-value">{{ stats().totalOrders }}</div>
          <div class="stat-label">Orders</div>
          <div class="stat-subtext">{{ stats().confirmedOrders }} confirmed</div>
        </div>
      </div>

      <div class="stat-item compact">
        <div class="stat-icon compact tickets">
          <mat-icon>chair</mat-icon>
        </div>
        <div class="stat-info compact">
          <div class="stat-value">{{ stats().totalSeats }}</div>
          <div class="stat-label">Seats</div>
          <div class="stat-subtext">{{ stats().activeSeats }} active</div>
        </div>
      </div>

      <div class="stat-item compact">
        <div class="stat-icon compact revenue">
          <mat-icon>attach_money</mat-icon>
        </div>
        <div class="stat-info compact">
          <div class="stat-value">${{ stats().totalRevenue | number:'1.0-0' }}</div>
          <div class="stat-label">Revenue</div>
          <div class="stat-subtext">
            <span class="fee">+${{ stats().totalServiceFees | number:'1.0-0' }}</span>
            <span class="discount">-${{ (stats().totalBulkDiscounts + stats().totalCouponDiscounts) | number:'1.0-0' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Compact Filters Section -->
  <div class="filters-section compact" *ngIf="showFilters()">
    <div class="filters-header compact">
      <div class="filters-title">
        <mat-icon>filter_list</mat-icon>
        <h3>Filters</h3>
        <span class="active-count" *ngIf="hasActiveFilters()">
          ({{ getActiveFilterCount() }} active)
        </span>
      </div>
      <div class="filters-actions">
        <button mat-button 
                color="warn" 
                (click)="clearFilters()"
                [disabled]="!hasActiveFilters()"
                class="compact">
          Clear All
        </button>
        <button mat-icon-button 
                (click)="toggleFilters()"
                class="close-filters">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>
    
    <div class="filters-content compact">
      <div class="filter-row">
        <!-- Search -->
        <mat-form-field appearance="outline" class="search-filter compact">
          <mat-icon matPrefix>search</mat-icon>
          <input matInput 
                 placeholder="Search orders..." 
                 [(ngModel)]="searchTerm" 
                 (keyup.enter)="applyFilters()"
                 [disabled]="loading()">
          <mat-hint>Press Enter to apply</mat-hint>
        </mat-form-field>
      </div>

      <div class="filter-row compact">
        <!-- Event Filter -->
        <mat-form-field appearance="outline" class="filter-field compact">
          <mat-label>Event</mat-label>
          <mat-select [(ngModel)]="selectedEvent" (selectionChange)="applyFilters()">
            <mat-option *ngFor="let eventOption of eventOptions" [value]="eventOption.value">
              {{ eventOption.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        
        <!-- Order Status Filter -->
        <mat-form-field appearance="outline" class="filter-field compact">
          <mat-label>Order Status</mat-label>
          <mat-select [(ngModel)]="selectedOrderStatus" (selectionChange)="applyFilters()">
            <mat-option *ngFor="let status of orderStatusOptions" [value]="status.value">
              {{ status.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Payment Status Filter -->
        <mat-form-field appearance="outline" class="filter-field compact">
          <mat-label>Payment Status</mat-label>
          <mat-select [(ngModel)]="selectedPaymentStatus" (selectionChange)="applyFilters()">
            <mat-option *ngFor="let status of paymentStatusOptions" [value]="status.value">
              {{ status.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="filter-actions compact">
        <button mat-button 
                color="primary" 
                (click)="applyFilters()"
                [disabled]="loading()"
                class="apply-btn">
          Apply Filters
        </button>
        <button mat-button 
                (click)="toggleFilters()"
                class="cancel-btn">
          Hide Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Orders Table Section -->
  <div class="table-section compact">
    <div class="table-header compact">
      <div class="table-info">
        <div class="results-info">
          <span class="results-count">
            {{ dataSource.filteredData.length }} of {{ stats().totalOrders }} orders
          </span>
          <span class="results-summary" *ngIf="hasActiveFilters()">
            • Filtered by {{ getActiveFilterCount() }} criteria
          </span>
        </div>
        <div class="table-actions compact">
          <button mat-button 
                  (click)="toggleFilters()"
                  class="show-filters-btn">
            <mat-icon>filter_list</mat-icon>
            {{ showFilters() ? 'Hide' : 'Show' }} Filters
          </button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <!-- Loading State -->
      <div class="loading-state" *ngIf="loading()">
        <mat-spinner diameter="32"></mat-spinner>
        <p>Loading orders...</p>
      </div>

      <!-- Empty State -->
      <div class="empty-state compact" *ngIf="!loading() && dataSource.filteredData.length === 0">
        <mat-icon class="empty-icon">receipt</mat-icon>
        <div class="empty-content">
          <h3>No orders found</h3>
          <p *ngIf="stats().totalOrders === 0; else filteredEmpty">
            No orders have been placed yet.
          </p>
          <ng-template #filteredEmpty>
            <p>No orders match your current filters.</p>
            <button mat-button color="primary" (click)="clearFilters()">
              Clear Filters
            </button>
          </ng-template>
        </div>
      </div>

      <!-- Orders Table -->
      <div *ngIf="!loading() && dataSource.filteredData.length > 0" class="orders-table compact">
        <!-- Table Headers -->
        <div class="table-headers compact">
          <div class="header-row compact">
            <div class="header-cell expand-col"></div>
            <div class="header-cell order-col">Order #</div>
            <div class="header-cell customer-col">Customer</div>
            <div class="header-cell event-col">Event</div>
            <div class="header-cell seats-col">Seats</div>
            <div class="header-cell amount-col">Amount</div>
            <div class="header-cell status-col">Status</div>
            <div class="header-cell actions-col"></div>
          </div>
        </div>

        <!-- Orders List -->
        <div class="orders-list compact">
          <div *ngFor="let order of dataSource.data" class="order-item compact">
            <!-- Order Header Row -->
            <div class="order-row compact" [class.expanded]="order.expanded">
              <div class="cell expand-col">
                <button mat-icon-button 
                        (click)="toggleOrderExpansion(order)" 
                        class="expand-button compact">
                  <mat-icon>{{ order.expanded ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
              </div>
              
              <div class="cell order-col compact">
                <strong class="order-number">{{ order.orderNumber }}</strong>
                <div class="order-date compact">{{ formatDate(order.createdAt) }}</div>
              </div>

              <div class="cell customer-col compact">
                <div class="customer-name">{{ order.customerName }}</div>
                <div class="customer-email">{{ order.customerEmail }}</div>
              </div>

              <div class="cell event-col compact">
                <span class="event-name">{{ order.eventName }}</span>
                <div class="event-date compact">{{ formatEventDate(order.eventDate) }}</div>
              </div>

              <div class="cell seats-col compact">
                <div class="seats-count">
                  {{ order.seatCount }} seats
                  <span class="seat-badge" 
                        [class]="getSeatStatusClass(!order.cancelledSeatsCount)"
                        matTooltip="{{ order.cancelledSeatsCount }} cancelled">
                    {{ order.cancelledSeatsCount > 0 ? '!' : '✓' }}
                  </span>
                </div>
              </div>

              <div class="cell amount-col compact">
                <div class="amount-container">
                  <div class="final-amount">${{ order.finalAmount | number:'1.2-2' }}</div>
                  <div class="amount-breakdown-trigger" 
                       *ngIf="order.totalAmount !== order.finalAmount"
                       matTooltip="Click to see breakdown">
                    <mat-icon>info</mat-icon>
                  </div>
                </div>
              </div>

              <div class="cell status-col compact">
                <div class="status-container">
                  <div class="status-badge" [class]="getStatusClass(order)">
                    <mat-icon class="status-icon">{{ getOrderStatusIcon(order.status) }}</mat-icon>
                    <span class="status-text">{{ getStatusText(order) }}</span>
                  </div>
                  <div class="payment-status" *ngIf="order.paymentStatus !== PaymentStatus.COMPLETED">
                    {{ getPaymentStatusText(order.paymentStatus) }}
                  </div>
                </div>
              </div>

              <div class="cell actions-col compact">
                <button mat-icon-button 
                        [matMenuTriggerFor]="orderMenu"
                        aria-label="Order actions"
                        class="actions-btn">
                  <mat-icon>more_vert</mat-icon>
                </button>
              </div>
            </div>

            <!-- Seats Expansion - Only show details on expansion -->
            <div class="seats-expansion compact" [class.expanded]="order.expanded">
              <div class="seats-header compact">
                <div class="seats-title">
                  <h4>Seats Details</h4>
                  <div class="seats-summary compact">
                    {{ order.seatCount }} seats • {{ order.cancelledSeatsCount }} cancelled
                    <span *ngIf="order.seatSummary">• {{ order.seatSummary }}</span>
                  </div>
                </div>
                <div class="seats-actions">
                  <button mat-button 
                          color="primary" 
                          (click)="viewOrder(order)"
                          class="compact">
                    View Full Order
                  </button>
                </div>
              </div>
              
              <!-- Seat Cards Grid -->
              <div class="seats-grid compact" *ngIf="order.expanded">
                <div *ngFor="let seat of order.orderSeats" 
                     class="seat-card compact" 
                     [class.cancelled]="seat.isCancelled">
                  <div class="seat-info compact">
                    <div class="seat-header compact">
                      <div class="seat-number-section">
                        <strong class="seat-number">{{ seat.seatNumber }}</strong>
                        <span class="section-name">{{ seat.sectionName || 'General' }}</span>
                      </div>
                      <div class="seat-status-type">
                        <span class="seat-type" [class]="getSeatTypeClass(seat.seatType)">
                          {{ getSeatTypeText(seat.seatType) }}
                        </span>
                        <span class="seat-status" 
                              [class]="getSeatStatusClass(seat.isCancelled)">
                          {{ getSeatStatusText(seat.isCancelled) }}
                        </span>
                      </div>
                    </div>
                    
                    <div class="seat-details compact">
                      <div class="seat-location">
                        Row {{ seat.rowLabel }}, Seat {{ seat.columnNumber }}
                      </div>
                      
                      <div class="seat-price compact">
                        <div class="price-breakdown">
                          <span>${{ seat.finalPrice | number:'1.2-2' }}</span>
                          <span class="price-details" 
                                *ngIf="seat.serviceFee > 0 || seat.bulkDiscount > 0 || seat.couponDiscount > 0">
                            (Base: ${{ seat.priceAtBooking | number:'1.2-2' }}
                            <span *ngIf="seat.serviceFee > 0"> + ${{ seat.serviceFee | number:'1.2-2' }} fee</span>
                            <span *ngIf="seat.bulkDiscount > 0"> - ${{ seat.bulkDiscount | number:'1.2-2' }} bulk</span>
                            <span *ngIf="seat.couponDiscount > 0"> - ${{ seat.couponDiscount | number:'1.2-2' }} coupon</span>)
                          </span>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Seat Actions -->
                    <div class="seat-actions compact" *ngIf="!seat.isCancelled && order.status === OrderStatus.CONFIRMED">
                      <button mat-stroked-button 
                              color="warn" 
                              size="small"
                              (click)="cancelSeat(order, seat.id)">
                        Cancel
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginator -->
    <mat-paginator [pageSizeOptions]="[10, 25, 50]" 
                   [pageSize]="25"
                   showFirstLastButtons
                   [length]="dataSource.filteredData.length"
                   class="compact-paginator">
    </mat-paginator>
  </div>
</div>

<!-- Order Actions Menu -->
<mat-menu #orderMenu="matMenu" class="compact-menu">
  <ng-template matMenuContent let-order="order">
    <button mat-menu-item (click)="viewOrder(order)">
      <mat-icon>visibility</mat-icon>
      <span>View Details</span>
    </button>
    
    <button mat-menu-item (click)="resendOrderConfirmation(order)" 
            *ngIf="order.status === OrderStatus.CONFIRMED">
      <mat-icon>email</mat-icon>
      <span>Resend Email</span>
    </button>

    <mat-divider></mat-divider>

    <button mat-menu-item 
            (click)="updateOrderStatus(order, OrderStatus.CONFIRMED)"
            *ngIf="order.status === OrderStatus.PENDING">
      <mat-icon>check_circle</mat-icon>
      <span>Confirm Order</span>
    </button>
    
    <button mat-menu-item 
            (click)="processRefund(order)"
            *ngIf="order.status === OrderStatus.CONFIRMED && order.paymentStatus === PaymentStatus.COMPLETED && order.finalAmount > 0">
      <mat-icon>monetization_on</mat-icon>
      <span>Process Refund</span>
    </button>
    
    <button mat-menu-item 
            (click)="updateOrderStatus(order, OrderStatus.CANCELLED)"
            *ngIf="order.status !== OrderStatus.CANCELLED"
            class="danger-action">
      <mat-icon>cancel</mat-icon>
      <span>Cancel Order</span>
    </button>
  </ng-template>
</mat-menu>