<!-- user-list.component.html -->
<div class="users-page">
  <!-- Header -->
  <div class="users-header">
    <div class="header-content">
      <h1>User Management</h1>
      <p>Manage users, roles, and event access permissions</p>
    </div>
  </div>

  <!-- Filters -->
<!-- Replace the Filters section in your HTML -->
<!-- Filters -->
<div class="filters-section mat-elevation-z1">
  <div class="filters-header">
    <div class="filters-title">
      <mat-icon>filter_list</mat-icon>
      <h3>Filter Users</h3>
    </div>
    <button mat-button (click)="clearFilters()" class="clear-all-btn" *ngIf="hasActiveFilters()">
      <mat-icon>filter_alt_off</mat-icon>
      Clear All
    </button>
  </div>

  <div class="filters-content">
    <div class="filter-row">
      <!-- Search Field -->
      <div class="filter-item search-item">
        <label class="filter-label">Search Users</label>

        <mat-form-field appearance="outline" class="search-field full-width">
          <input matInput [(ngModel)]="filter.search" (input)="applyFilters()" 
                 placeholder="Name, email, username...">
          <mat-icon matPrefix>search</mat-icon>
          <button mat-icon-button matSuffix *ngIf="filter.search" (click)="clearSearch()" class="clear-search">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>
      </div>

      <!-- Status Filter -->
      <div class="filter-item">
        <label class="filter-label">Status</label>
        <mat-form-field appearance="outline" class="status-field">
          <mat-select [(ngModel)]="filter.status" (selectionChange)="applyFilters()" 
                     [value]="filter.status || 'all'">
            <mat-option value="all">
              <div class="option-content">
                <span>All Status</span>
              </div>
            </mat-option>
            <mat-option value="active">
              <div class="option-content">
                <mat-icon class="active-icon">check_circle</mat-icon>
                <span>Active</span>
              </div>
            </mat-option>
            <mat-option value="inactive">
              <div class="option-content">
                <mat-icon class="inactive-icon">cancel</mat-icon>
                <span>Inactive</span>
              </div>
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Role Filter -->
      <div class="filter-item">
        <label class="filter-label">Role</label>
        <mat-form-field appearance="outline" class="role-field">
          <mat-select [(ngModel)]="filter.role" (selectionChange)="applyFilters()" 
                     [value]="filter.role || 'all'">
            <mat-option value="all">
              <div class="option-content">
                <span>All Roles</span>
              </div>
            </mat-option>
            <mat-option *ngFor="let role of roles" [value]="role">
              <div class="option-content">
                <mat-icon [class]="getRoleIcon(role)">{{ getRoleIcon(role) }}</mat-icon>
                <span>{{ role }}</span>
              </div>
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Active Filters Display -->
      <div class="active-filters" *ngIf="hasActiveFilters()">
        <div class="active-filters-label">Active Filters:</div>
        <div class="active-filter-chips">
          <mat-chip *ngIf="filter.search" (removed)="clearSearch()" class="search-chip">
            Search: "{{ filter.search }}"
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
          <mat-chip *ngIf="filter.status && filter.status !== 'all'" 
                   (removed)="clearFilter('status')" class="status-chip">
            Status: {{ filter.status === 'active' ? 'Active' : 'Inactive' }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
          <mat-chip *ngIf="filter.role && filter.role !== 'all'" 
                   (removed)="clearFilter('role')" class="role-chip">
            Role: {{ filter.role }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </div>
      </div>
    </div>

    <!-- Results Summary -->
    <div class="results-summary" *ngIf="!isLoading">
      <div class="summary-content">
        <mat-icon>people</mat-icon>
        <span>
          Showing <strong>{{ filteredUsers.length }}</strong> of 
          <strong>{{ users.length }}</strong> users
        </span>
        <span class="summary-divider">â€¢</span>
      </div>
    </div>
  </div>
</div>

  <!-- Users Table -->
  <div class="users-table-container mat-elevation-z2">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading users...</p>
    </div>

    <!-- Users Table -->
    <table *ngIf="!isLoading" mat-table [dataSource]="filteredUsers" class="users-table">
      
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef class="header-name">User</th>
        <td mat-cell *matCellDef="let user">
          <div class="user-info">
            <div class="user-details">
              <div class="user-name">{{ user.firstName }} {{ user.lastName }}</div>
              <div class="user-email">{{ user.email }}</div>
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Roles Column -->
      <ng-container matColumnDef="roles">
        <th mat-header-cell *matHeaderCellDef>Roles</th>
        <td mat-cell *matCellDef="let user">
          <div class="roles-list">
            <span *ngFor="let role of user.roles; let last = last">
              <mat-chip [class]="getRoleClass(role)" [disableRipple]="true">
                {{ role }}
              </mat-chip>
              <span *ngIf="!last" class="chip-divider"></span>
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Access Column -->
      <ng-container matColumnDef="access">
        <th mat-header-cell *matHeaderCellDef>Event Access</th>
        <td mat-cell *matCellDef="let user">
          <div class="access-info">
            <div class="access-status" [class.has-access]="getEventCount(user) > 0">
              <mat-icon class="status-icon" *ngIf="getEventCount(user) > 0">event_available</mat-icon>
              <mat-icon class="status-icon" *ngIf="getEventCount(user) === 0">event_busy</mat-icon>
              <span class="event-count">{{ getEventCount(user) > 0 ? getEventCount(user) + ' event(s)' : 'No access' }}</span>
            </div>
            <button mat-stroked-button color="primary" class="manage-btn" 
                    (click)="showAssignEvents(user)">
              <mat-icon>settings</mat-icon>
              Manage
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Created Date Column -->
      <ng-container matColumnDef="created">
        <th mat-header-cell *matHeaderCellDef>Joined</th>
        <td mat-cell *matCellDef="let user">
          <div class="date-info">
            <div class="date-main">{{ user.createdAt | date: 'MMM d, y' }}</div>
            <div class="time-since">{{ getTimeSince(user.createdAt) }}</div>
          </div>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let user">
          <div class="status-info">
            <div class="status-indicator" [class.active]="user.isActive"></div>
            <span class="status-label">{{ user.isActive ? 'Active' : 'Inactive' }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="header-actions">Actions</th>
        <td mat-cell *matCellDef="let user">
          <button mat-icon-button [matMenuTriggerFor]="userMenu" class="menu-btn mat-elevation-z1">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #userMenu="matMenu" class="user-actions-menu">
            <button mat-menu-item (click)="showAssignEvents(user)">
              <mat-icon>event</mat-icon>
              <span>Manage Events</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="toggleUserStatus(user)">
              <mat-icon>{{ user.isActive ? 'toggle_off' : 'toggle_on' }}</mat-icon>
              <span>{{ user.isActive ? 'Deactivate' : 'Activate' }}</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
          class="user-row" [class.selected]="selectedUser?.id === row.id"></tr>
    </table>

    <!-- Empty State -->
    <div *ngIf="!isLoading && filteredUsers.length === 0" class="empty-state mat-elevation-z1">
      <mat-icon class="empty-icon">group_off</mat-icon>
      <h3>No users found</h3>
      <p>Try adjusting your search criteria or clear filters</p>
      <button mat-raised-button (click)="clearFilters()" color="primary">
        <mat-icon>filter_alt_off</mat-icon>
        Clear All Filters
      </button>
    </div>

    <!-- Pagination -->
    <div *ngIf="!isLoading && filteredUsers.length > 0" class="table-footer">
      <div class="results-count">
        Showing {{ filteredUsers.length }} of {{ users.length }} users
      </div>
    </div>
  </div>

  <!-- Event Assignment Panel -->
  <div *ngIf="showEventPanel" class="event-panel-overlay" (click)="closeEventPanel()">
    <div class="event-panel mat-elevation-z24" (click)="$event.stopPropagation()">
      <div class="panel-header">
        <div class="panel-header-content">
          <mat-icon class="panel-icon">event</mat-icon>
          <div class="panel-title">
            <h2>Manage Events</h2>
            <p class="user-subtitle">{{ selectedUser?.firstName }} {{ selectedUser?.lastName }}</p>
          </div>
        </div>
        <button mat-icon-button (click)="closeEventPanel()" class="close-btn">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="panel-content">
        <!-- Loading -->
        <div *ngIf="panelLoading" class="panel-loading">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading events...</p>
        </div>
        
        <!-- Current Events -->
        <div *ngIf="!panelLoading && userEvents.length > 0" class="current-events-section">
          <div class="section-header">
            <mat-icon>check_circle</mat-icon>
            <h3>Current Events ({{ userEvents.length }})</h3>
          </div>
          <div class="current-events-list">
            <div *ngFor="let userEvent of userEvents" class="current-event-item mat-elevation-z1">
              <div class="event-main-info">
                <div class="event-name">{{ userEvent.eventName }}</div>
                <div class="event-meta">
                  <span class="event-code">{{ userEvent.eventCode }}</span>
                  <span class="event-date">Granted: {{ userEvent.grantedAt | date: 'MMM d, y' }}</span>
                </div>
              </div>
              <div class="event-actions">
                <mat-form-field appearance="outline" class="access-select">
                  <mat-label>Access Level</mat-label>
                  <mat-select [(ngModel)]="userEvent.accessLevel" 
                             (selectionChange)="updateAccessLevel(userEvent.eventId, userEvent.accessLevel)">
                    <mat-option *ngFor="let level of accessLevels" [value]="level.value">
                      {{ level.label }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <button mat-icon-button color="warn" (click)="removeEvent(userEvent.eventId)" 
                        matTooltip="Remove access" class="remove-btn">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Available Events -->
        <div *ngIf="!panelLoading" class="available-events-section">
          <div class="section-header">
            <mat-icon>add_circle</mat-icon>
            <h3>Available Events ({{ availableEvents.length }})</h3>
          </div>
          
          <div *ngIf="availableEvents.length > 0">
            <!-- Access Level Selection -->
            <div class="access-level-section mat-elevation-z1" *ngIf="selectedEventIds.length > 0">
              <div class="access-level-info">
                <div class="selected-info">
                  <div class="selected-count" >
                    <mat-icon>check_circle</mat-icon>
                    {{ selectedEventIds.length }} event(s) selected
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Events List -->
            <div class="available-events-list mat-elevation-z1">
              <div *ngFor="let event of availableEvents" class="available-event-item">
                <mat-checkbox [checked]="isEventSelected(event.id)" 
                             (change)="toggleEventSelection(event.id)"
                             class="event-checkbox">
                  <div class="event-info">
                    <div class="event-name">{{ event.title }}</div>
                    <div class="event-details">
                      <span class="event-code">{{ event.code }}</span>
                    </div>
                    <span class="event-status" [class]="event.isActive ? 'active' : 'inactive'">
                      {{ event.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </div>
                </mat-checkbox>
              </div>
            </div>
            
            <!-- Assign Button -->
            <div class="panel-actions">
              <button mat-raised-button color="primary" 
                      (click)="assignEvents()"
                      [disabled]="selectedEventIds.length === 0"
                      class="assign-btn">
                <mat-icon>add</mat-icon>
                Assign Selected Events
              </button>
              <button mat-stroked-button (click)="closeEventPanel()" class="cancel-btn">
                Cancel
              </button>
            </div>
          </div>
          
          <div *ngIf="availableEvents.length === 0" class="no-events-message mat-elevation-z1">
            <mat-icon>event_busy</mat-icon>
            <div class="message-content">
              <h4>No available events</h4>
              <p>There are no more events to assign to this user</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>